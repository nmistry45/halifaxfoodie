<!-- 
    References: 
    1. https://stackoverflow.com/questions/70884804/how-do-i-initiate-a-conversation-with-aws-lex-from-node-js
    2. https://github.com/AlexWang-16/react-lex-plus/blob/master/src/index.js
    3. https://docs.amazonaws.cn/en_us/sdk-for-javascript/v3/developer-guide/lex-bot-example-script.html
    4. https://docs.aws.amazon.com/lexv2/latest/APIReference/API_Types_Amazon_Lex_Runtime_V2.html
 -->

<!DOCTYPE html5>
<html>
  <head>
    <title>Chat Bot</title>
    <script type="text/javascript" src="./aws-sdk-2.1176.0.js"></script>
    <script type="text/javascript" src="./aws_credentials.js"></script>
    <style language="text/css">
      input#wisdom {
        padding: 8px;
        font-size: 1em;
        width: 400px;
      }

      input::placeholder {
        color: #ccc;
      }

      p.userRequest {
        margin: 5px;
        padding: 5px 11px 5px 11px;
        border-radius: 5px;
        text-align: left;
        min-width: 55%;
        max-width: 80%;
        float: left;
        background-color: #9fa8da;
      }

      p.lexResponse {
        margin: 5px;
        padding: 5px 11px 5px 11px;
        border-radius: 5px;
        text-align: right;
        min-width: 55%;
        max-width: 80%;
        float: right;
        background-color: #90caf9;
      }

    </style>
  </head>

  <body>
    
    <div style="display: inline-flex; align-content: center; justify-content: center;">
      <img src="https://freesvg.org/img/1538298822.png" height="15%" width="20%"/>
      <h2 style="text-align: -webkit-center; padding-top: 10px;">Halifax Foodie Bot</h1>
    </div>
    <div>
      <div
        id="conversation"
        style="
          width: 100%;
          height: 60%;
          border: 1px solid #ccc;
          background-color: #ffffff;
          padding: 4px;
          overflow: scroll;
        "
      ></div>
    </div>

    <form
      id="chatform"
      style="margin-top: 20px; text-align: -webkit-center"
      onsubmit="return chatBot();"
    >
      <input
        type="text"
        id="wisdom"
        size="100"
        value=""
        placeholder="What can I help with today?"
      />
    </form>
    <script type="text/javascript">
      document.getElementById("wisdom").focus();

      AWS.config.region = "us-east-1";
      AWS.config.credentials = new AWS.Credentials(
        aws_access_key_id,
        aws_secret_access_key,
        aws_session_token
      );

      const lexruntime = new AWS.LexRuntimeV2();
      const lexUserId = "chatbot" + Date.now();

      function chatBot() {
        const inputText = document.getElementById("wisdom");
        if (
          inputText &&
          inputText.value &&
          inputText.value.trim().length > 0
        ) {
          const input = inputText.value.trim();
          inputText.value = "...";
          inputText.locked = true;

          let sessionAttributes = { UserID: "Nishit Mistry", email: "Dharmik.Soni@dal.ca" };
          let attributes = { sessionAttributes: sessionAttributes };

          const params = {
            botAliasId: bot_alias_id,
            botId: bot_id,
            text: input,
            sessionState: attributes,
            sessionId: lexUserId,
            localeId: "en_US",
          };
          showRequest(input);
          lexruntime.recognizeText(params, function (err, data) {
            if (err) {
              console.log(err, err.stack);
            }
            if (data) {
              messages = data.messages;
              showResponse(data);
            }
            inputText.value = "";
            inputText.locked = false;
          });
        }
        return false;
      }

      function showRequest(request) {
        const conversationDiv = document.getElementById("conversation");
        const requestPara = document.createElement("P");
        requestPara.className = "userRequest";
        requestPara.appendChild(document.createTextNode(request));
        conversationDiv.appendChild(requestPara);
        conversationDiv.scrollTop = conversationDiv.scrollHeight;
      }

      function showResponse(response) {
        const conversationDiv = document.getElementById("conversation");
        let responseDiv = document.createElement("div");
        if (response.messages) {
          let messages = response.messages;
          messages.forEach((ele) => {
            const responsePara = document.createElement("P");
            responsePara.className = "lexResponse";
            responsePara.innerHTML = ele.content.replace(/"/g, "'");
            responsePara.appendChild(document.createElement("br"));
            responseDiv.appendChild(responsePara);
          });
        }
        if (response.dialogState === "ReadyForFulfillment") {
          responseDiv.appendChild(
            document.createTextNode("Ready for fulfillment")
          );
        }
        conversationDiv.appendChild(responseDiv);
        conversationDiv.scrollTop = conversationDiv.scrollHeight;
      }
    </script>
  </body>
</html>
